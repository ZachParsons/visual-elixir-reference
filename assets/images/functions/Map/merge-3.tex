\matrix [fptk, map=a1] {
    \keyvalue{1} &
    \elems &
    \keyvalue{i} \\
};

\matrix [fptk, map=a2, below=1.5 of a1i.south, matrix anchor=a2i.north] {
    \node (i) [align=left] {$\ k_i$};
    \draw [fptk, map ->, shorten >=2ex] (.33, -.5\masterunit + .5ex + \defaultpenwidth) -- +(0, -1)
        node (i=>v) [draw=none, minimum size=0pt, text width=, inner sep=0pt, anchor=base] {$v_i^\prime$}
    ; &
    \elems &
    \keyvalue{n} \\
};

\draw [dashed]
    ([yshift=.5\masterunit] a1i.north west) -- ([yshift=-.5\masterunit] a2i.south west)
    ([yshift=.5\masterunit] a1i.north east) -- ([yshift=-.5\masterunit] a2i.south east);

\matrix [fptk, map=b] [below=3 of a2i.south west, matrix anchor=bi.north west] {
    \keyvalue{1} &
    \elems &
    \node (i) [align=left] {$\ k_i$};
    \draw [fptk, map ->, shorten >=2ex] (-.33, -.5\masterunit + .5ex + \defaultpenwidth) -- +(0, -1)
        node (i=>v) [draw=none, minimum size=0pt, text width=, inner sep=0pt, anchor=base] {$v_i^{\prime\prime}$}
    ; &
    \elems &
    \keyvalue{n} \\
};

\node (fun) at ($ (a2i)!.6!(bi) $) [/fptk/fun, /function/north io=3];

\draw [fptk, <- subflow] (fun.north io 1) -- ([yshift=-1ex] \currcoord |- a2i.base);
\draw [fptk, <- subflow] (a2i.north) -- (a1i=>v.south) (fun.north io 2) -- (a2i.south);
\draw [fptk, subflow] [loosely dash dot] (a2i.north) -- (a2i.south);
\draw [fptk, <- subflow] (fun.north io 3) -- (\currcoord |- a2i=>v.south);

\draw [fptk, flow ->]
    (fun.south io) -- (bi.north)
    (bi.south) |- (bi=>v.east);
\draw [fptk, flow, loosely dash dot] (bi.north) -- (bi.south);

\bracetobrace
    {[yshift=-\masterunit] a1i.south west}
    {[yshift=-\masterunit] a11.south west}
    {b1.north west}
    {bi.north west}

\bracetobrace
    {[yshift=-\masterunit] a2n.south east}
    {[yshift=-\masterunit] a2i.south east}
    {bi.north east}
    {bn.north east}
